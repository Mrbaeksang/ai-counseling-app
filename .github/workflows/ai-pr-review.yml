name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AI Code Review
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const diff = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha
            });
            
            // ëª¨ë“  ë³€ê²½ íŒŒì¼ ë¦¬ë·° (ë°”ì´ë„ˆë¦¬ ì œì™¸)
            const filesToReview = diff.data.files.filter(file => 
              file.patch && // íŒ¨ì¹˜ê°€ ìˆëŠ” íŒŒì¼ë§Œ (ë°”ì´ë„ˆë¦¬ ì œì™¸)
              !file.filename.includes('test/resources/') &&
              !file.filename.includes('build/')
            );
            
            if (filesToReview.length === 0) {
              console.log('No files to review');
              return;
            }
            
            console.log(`Found ${filesToReview.length} files to review`);
            
            // íŒŒì¼ íƒ€ì…ë³„ ë¶„ë¥˜
            const fileCategories = {
              entities: [],
              services: [],
              controllers: [],
              dtos: [],
              repositories: [],
              configs: [],
              tests: [],
              others: []
            };
            
            filesToReview.forEach(file => {
              if (file.filename.includes('/entity/')) fileCategories.entities.push(file);
              else if (file.filename.includes('/service/')) fileCategories.services.push(file);
              else if (file.filename.includes('/controller/')) fileCategories.controllers.push(file);
              else if (file.filename.includes('/dto/')) fileCategories.dtos.push(file);
              else if (file.filename.includes('/repository/')) fileCategories.repositories.push(file);
              else if (file.filename.includes('/config/') || file.filename.endsWith('.yml') || file.filename.endsWith('.yaml')) fileCategories.configs.push(file);
              else if (file.filename.includes('/test/')) fileCategories.tests.push(file);
              else fileCategories.others.push(file);
            });
            
            // ì „ì²´ ë³€ê²½ì‚¬í•­ ìš”ì•½
            const summary = {
              total: filesToReview.length,
              additions: diff.data.files.reduce((sum, f) => sum + f.additions, 0),
              deletions: diff.data.files.reduce((sum, f) => sum + f.deletions, 0),
              categories: Object.entries(fileCategories).filter(([_, files]) => files.length > 0)
                .map(([category, files]) => `${category}: ${files.length}ê°œ`)
            };
            
            // PR ì „ì²´ ë¦¬ë·° ì‹œì‘
            let overallReview = `# ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ë³´ê³ ì„œ\n\n`;
            overallReview += `## ğŸ“Š ë³€ê²½ í†µê³„\n`;
            overallReview += `- **ì´ íŒŒì¼ ìˆ˜**: ${summary.total}ê°œ\n`;
            overallReview += `- **ì¶”ê°€ëœ ë¼ì¸**: +${summary.additions}\n`;
            overallReview += `- **ì‚­ì œëœ ë¼ì¸**: -${summary.deletions}\n`;
            overallReview += `- **ì¹´í…Œê³ ë¦¬ë³„**: ${summary.categories.join(', ')}\n\n`;
            
            // ì•„í‚¤í…ì²˜ ë ˆë²¨ ë¦¬ë·°ë¥¼ ìœ„í•œ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
            const architectureContext = {
              hasEntityChanges: fileCategories.entities.length > 0,
              hasServiceChanges: fileCategories.services.length > 0,
              hasControllerChanges: fileCategories.controllers.length > 0,
              hasDtoChanges: fileCategories.dtos.length > 0,
              hasTestChanges: fileCategories.tests.length > 0,
              fileNames: filesToReview.map(f => f.filename)
            };
            
            // ì „ì²´ ì•„í‚¤í…ì²˜ ë¦¬ë·°
            if (summary.total > 3) {
              try {
                const archResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    model: 'deepseek/deepseek-r1-0528:free',  // ì•„í‚¤í…ì²˜ ë¶„ì„ìš© (ì¶”ë¡  ëŠ¥ë ¥ ìš°ìˆ˜)
                    messages: [{
                      role: 'system',
                      content: `ë‹¹ì‹ ì€ Kotlin Spring Boot ì•„í‚¤í…ì²˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                      Clean Architectureì™€ DDD ì›ì¹™ì„ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ì ì¸ ì„¤ê³„ë¥¼ í‰ê°€í•´ì£¼ì„¸ìš”.`
                    }, {
                      role: 'user',
                      content: `PR ì „ì²´ ë³€ê²½ì‚¬í•­:
                      - Entity ë³€ê²½: ${fileCategories.entities.map(f => f.filename).join(', ')}
                      - Service ë³€ê²½: ${fileCategories.services.map(f => f.filename).join(', ')}
                      - Controller ë³€ê²½: ${fileCategories.controllers.map(f => f.filename).join(', ')}
                      - DTO ë³€ê²½: ${fileCategories.dtos.map(f => f.filename).join(', ')}
                      
                      ì•„í‚¤í…ì²˜ ê´€ì ì—ì„œ ë‹¤ìŒì„ í‰ê°€í•´ì£¼ì„¸ìš”:
                      1. ê³„ì¸µê°„ ì˜ì¡´ì„± ë°©í–¥
                      2. ë„ë©”ì¸ ë¡œì§ ìœ„ì¹˜ì˜ ì ì ˆì„±
                      3. DTOì™€ Entity ë¶„ë¦¬
                      4. íŠ¸ëœì­ì…˜ ê²½ê³„
                      5. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€`
                    }],
                    max_tokens: 1000,
                    temperature: 0.3
                  })
                });
                
                if (archResponse.ok) {
                  const result = await archResponse.json();
                  overallReview += `## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ë¦¬ë·°\n${result.choices[0].message.content}\n\n`;
                }
              } catch (error) {
                console.error('Architecture review failed:', error);
              }
            }
            
            overallReview += `## ğŸ“ íŒŒì¼ë³„ ìƒì„¸ ë¦¬ë·°\n\n`;
            
            // ëª¨ë“  íŒŒì¼ ë¦¬ë·° (ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì •ë¦¬)
            for (const [category, files] of Object.entries(fileCategories)) {
              if (files.length === 0) continue;
              
              overallReview += `### ${category.toUpperCase()}\n\n`;
              
              for (const file of files) {
                console.log(`Reviewing ${category}: ${file.filename}`);
                
                // íŒŒì¼ íƒ€ì…ë³„ ë§ì¶¤ í”„ë¡¬í”„íŠ¸ ë° ëª¨ë¸ ì„ íƒ
                let systemPrompt = '';
                let modelName = '';
                
                if (category === 'entities') {
                  modelName = 'deepseek/deepseek-r1-0528-qwen3-8b:free'; // êµ¬ì¡° ë¶„ì„ì— ê°•í•¨
                  systemPrompt = `ë‹¹ì‹ ì€ JPA/Hibernate ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
                  - @Entity, @Table ì–´ë…¸í…Œì´ì…˜ ì ì ˆì„±
                  - ì—°ê´€ê´€ê³„ ë§¤í•‘ (@OneToMany, @ManyToOne ë“±)
                  - Lazy/Eager ë¡œë”© ì „ëµ
                  - equals/hashCode êµ¬í˜„
                  - Kotlin data class ì‚¬ìš© ì‹œ ì£¼ì˜ì 
                  - N+1 ë¬¸ì œ ê°€ëŠ¥ì„±`;
                } else if (category === 'services') {
                  modelName = 'qwen/qwen3-coder:free'; // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì½”ë“œ ë¦¬ë·° ìµœì í™”
                  systemPrompt = `ë‹¹ì‹ ì€ Spring Boot ì„œë¹„ìŠ¤ ë ˆì´ì–´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
                  - @Transactional ì ì ˆì„±
                  - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì¹˜
                  - ì˜ˆì™¸ ì²˜ë¦¬ ì „ëµ
                  - DTO <-> Entity ë³€í™˜
                  - ì˜ì¡´ì„± ì£¼ì… ë°©ì‹
                  - ë©”ì„œë“œ ë‹¨ì¼ ì±…ì„ ì›ì¹™`;
                } else if (category === 'controllers') {
                  modelName = 'qwen/qwen3-coder:free'; // API ì„¤ê³„ ì½”ë“œ ë¦¬ë·°
                  systemPrompt = `ë‹¹ì‹ ì€ Spring REST API ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
                  - RESTful ì›ì¹™ ì¤€ìˆ˜
                  - HTTP ìƒíƒœ ì½”ë“œ ì ì ˆì„±
                  - @Valid ê²€ì¦
                  - Request/Response DTO ì‚¬ìš©
                  - API ë²„ì €ë‹
                  - Swagger ë¬¸ì„œí™”`;
                } else if (category === 'dtos') {
                  modelName = 'deepseek/deepseek-r1-0528-qwen3-8b:free'; // ë°ì´í„° êµ¬ì¡° ë¶„ì„
                  systemPrompt = `ë‹¹ì‹ ì€ Kotlin DTO ì„¤ê³„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
                  - data class ì ì ˆì„±
                  - nullable íƒ€ì… ì‚¬ìš©
                  - ê¸°ë³¸ê°’ ì„¤ì •
                  - @Valid ì–´ë…¸í…Œì´ì…˜
                  - JSON ì§ë ¬í™” ì„¤ì •
                  - ë¶ˆë³€ì„± ë³´ì¥`;
                } else if (category === 'repositories') {
                  modelName = 'qwen/qwen3-coder:free'; // SQL/JPQL ìµœì í™”
                  systemPrompt = `ë‹¹ì‹ ì€ Spring Data JPA ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
                  - ì¿¼ë¦¬ ë©”ì„œë“œ ë„¤ì´ë°
                  - @Query JPQL ìµœì í™”
                  - í˜ì´ì§•/ì •ë ¬ ì²˜ë¦¬
                  - Custom Repository êµ¬í˜„
                  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ê³ ë ¤`;
                } else if (category === 'tests') {
                  modelName = 'qwen/qwen3-coder:free'; // í…ŒìŠ¤íŠ¸ ì½”ë“œ ë¶„ì„
                  systemPrompt = `ë‹¹ì‹ ì€ Kotlin í…ŒìŠ¤íŠ¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
                  - @SpringBootTest vs @WebMvcTest ì ì ˆì„±
                  - MockK ì‚¬ìš©ë²•
                  - Given-When-Then íŒ¨í„´
                  - í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
                  - í…ŒìŠ¤íŠ¸ ê²©ë¦¬ì„±
                  - Kotest vs JUnit5 ì¼ê´€ì„±`;
                } else if (category === 'configs') {
                  modelName = 'deepseek/deepseek-r1-0528:free'; // ì„¤ì • íŒŒì¼ ë¶„ì„
                  systemPrompt = `ë‹¹ì‹ ì€ Spring Boot ì„¤ì • ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
                  - í™˜ê²½ë³„ ì„¤ì • ë¶„ë¦¬
                  - ë³´ì•ˆ ì •ë³´ ë…¸ì¶œ
                  - ì„¤ì •ê°’ ê²€ì¦
                  - í”„ë¡œíŒŒì¼ ì „ëµ
                  - YAML êµ¬ì¡°`;
                } else {
                  modelName = 'qwen/qwen3-coder:free'; // ê¸°ë³¸ ì½”ë“œ ë¦¬ë·°
                  systemPrompt = `ë‹¹ì‹ ì€ Kotlin Spring Boot ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                  Kotlin ê´€ìš©êµ¬ì™€ Spring Boot ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”.`;
                }
                
                try {
                  const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      model: modelName,  // ì¹´í…Œê³ ë¦¬ë³„ ìµœì  ëª¨ë¸ ì‚¬ìš©
                      messages: [{
                        role: 'system',
                        content: systemPrompt + `
                        
                        ì‘ë‹µ í˜•ì‹:
                        ğŸŸ¢ **Good**: ì˜ ì‘ì„±ëœ ë¶€ë¶„ (ê°„ë‹¨íˆ)
                        ğŸŸ¡ **Suggest**: ê°œì„  ì œì•ˆ (êµ¬ì²´ì ìœ¼ë¡œ)
                        ğŸ”´ **Issue**: ë¬¸ì œì  (ë°˜ë“œì‹œ ìˆ˜ì • í•„ìš”)
                        ğŸ’¡ **Tip**: ì¶”ê°€ ê°œì„  ì•„ì´ë””ì–´
                        
                        ì½”ë“œ ì˜ˆì‹œë¥¼ ì œê³µí•  ë•ŒëŠ” ë°˜ë“œì‹œ Kotlin ë¬¸ë²•ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.`
                      }, {
                        role: 'user',
                        content: `íŒŒì¼: ${file.filename}
                        ì¶”ê°€: +${file.additions} ì¤„
                        ì‚­ì œ: -${file.deletions} ì¤„
                        
                        ë³€ê²½ì‚¬í•­:
                        \`\`\`diff
                        ${file.patch}
                        \`\`\`
                        
                        ìœ„ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.`
                      }],
                      max_tokens: 800,
                      temperature: 0.2
                    })
                  });
                  
                  if (response.ok) {
                    const result = await response.json();
                    const review = result.choices[0].message.content;
                    
                    overallReview += `#### ğŸ“„ \`${file.filename}\`\n`;
                    overallReview += `> ğŸ“ˆ +${file.additions} / -${file.deletions} lines\n\n`;
                    overallReview += review + '\n\n';
                  } else {
                    console.error(`Failed to review ${file.filename}:`, response.statusText);
                    overallReview += `#### ğŸ“„ \`${file.filename}\`\n`;
                    overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: API ì‘ë‹µ ì˜¤ë¥˜\n\n`;
                  }
                } catch (error) {
                  console.error(`Error reviewing ${file.filename}:`, error);
                  overallReview += `#### ğŸ“„ \`${file.filename}\`\n`;
                  overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${error.message}\n\n`;
                }
                
                // API ì œí•œ ë°©ì§€ (0.5ì´ˆ ë”œë ˆì´)
                await new Promise(resolve => setTimeout(resolve, 500));
              }
            }
            
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
            overallReview += `## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸\n\n`;
            overallReview += `- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ëŠ”ê°€?\n`;
            overallReview += `- [ ] Ktlint ê·œì¹™ì„ ì¤€ìˆ˜í•˜ëŠ”ê°€?\n`;
            overallReview += `- [ ] API ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ê°€?\n`;
            overallReview += `- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ê°€ í•„ìš”í•œê°€?\n`;
            overallReview += `- [ ] ë³´ì•ˆ ì·¨ì•½ì ì€ ì—†ëŠ”ê°€?\n\n`;
            
            overallReview += `---\n`;
            overallReview += `*ğŸ¤– AI Review powered by:*\n`;
            overallReview += `*â€¢ Qwen3 Coder (ì½”ë“œ ë¦¬ë·°)*\n`;
            overallReview += `*â€¢ DeepSeek R1 (ì•„í‚¤í…ì²˜ ë¶„ì„)*\n`;
            overallReview += `*â€¢ DeepSeek R1-Qwen3 (êµ¬ì¡° ë¶„ì„)*\n`;
            overallReview += `*via OpenRouter (Free Models)*\n`;
            overallReview += `*â±ï¸ Reviewed at: ${new Date().toISOString()}*`;
            
            // ìµœì¢… ë¦¬ë·° ì œì¶œ
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: overallReview,
              event: 'COMMENT'
            });
            
            console.log(`âœ… Review completed for ${filesToReview.length} files!`);