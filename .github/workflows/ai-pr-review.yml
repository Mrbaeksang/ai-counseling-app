name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AI Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const OPENROUTER_API_KEY = '${{ secrets.OPENROUTER_API_KEY }}';
            
            const diff = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha
            });
            
            // ëª¨ë“  ë³€ê²½ íŒŒì¼ ë¦¬ë·° (ë°”ì´ë„ˆë¦¬ ì œì™¸)
            const filesToReview = diff.data.files.filter(file => 
              file.patch && // íŒ¨ì¹˜ê°€ ìˆëŠ” íŒŒì¼ë§Œ (ë°”ì´ë„ˆë¦¬ ì œì™¸)
              !file.filename.includes('test/resources/') &&
              !file.filename.includes('build/')
            );
            
            if (filesToReview.length === 0) {
              console.log('No files to review');
              return;
            }
            
            console.log(`Found ${filesToReview.length} files to review`);
            
            // íŒŒì¼ íƒ€ì…ë³„ ë¶„ë¥˜
            const fileCategories = {
              entities: [],
              services: [],
              controllers: [],
              dtos: [],
              repositories: [],
              configs: [],
              tests: [],
              others: []
            };
            
            filesToReview.forEach(file => {
              if (file.filename.includes('/entity/')) fileCategories.entities.push(file);
              else if (file.filename.includes('/service/')) fileCategories.services.push(file);
              else if (file.filename.includes('/controller/')) fileCategories.controllers.push(file);
              else if (file.filename.includes('/dto/')) fileCategories.dtos.push(file);
              else if (file.filename.includes('/repository/')) fileCategories.repositories.push(file);
              else if (file.filename.includes('/config/') || file.filename.endsWith('.yml') || file.filename.endsWith('.yaml')) fileCategories.configs.push(file);
              else if (file.filename.includes('/test/')) fileCategories.tests.push(file);
              else fileCategories.others.push(file);
            });
            
            // ì „ì²´ ë³€ê²½ì‚¬í•­ ìš”ì•½
            const summary = {
              total: filesToReview.length,
              additions: diff.data.files.reduce((sum, f) => sum + f.additions, 0),
              deletions: diff.data.files.reduce((sum, f) => sum + f.deletions, 0),
              categories: Object.entries(fileCategories).filter(([_, files]) => files.length > 0)
                .map(([category, files]) => `${category}: ${files.length}ê°œ`)
            };
            
            // PR ì „ì²´ ë¦¬ë·° ì‹œì‘
            let overallReview = `# ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ë³´ê³ ì„œ\n\n`;
            overallReview += `## ğŸ“Š ë³€ê²½ í†µê³„\n`;
            overallReview += `- **ì´ íŒŒì¼ ìˆ˜**: ${summary.total}ê°œ\n`;
            overallReview += `- **ì¶”ê°€ëœ ë¼ì¸**: +${summary.additions}\n`;
            overallReview += `- **ì‚­ì œëœ ë¼ì¸**: -${summary.deletions}\n`;
            overallReview += `- **ì¹´í…Œê³ ë¦¬ë³„**: ${summary.categories.join(', ')}\n\n`;
            
            // ì•„í‚¤í…ì²˜ ë ˆë²¨ ë¦¬ë·°ë¥¼ ìœ„í•œ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
            const architectureContext = {
              hasEntityChanges: fileCategories.entities.length > 0,
              hasServiceChanges: fileCategories.services.length > 0,
              hasControllerChanges: fileCategories.controllers.length > 0,
              hasDtoChanges: fileCategories.dtos.length > 0,
              hasTestChanges: fileCategories.tests.length > 0,
              fileNames: filesToReview.map(f => f.filename)
            };
            
            // ëª¨ë“  íŒŒì¼ ë³€ê²½ì‚¬í•­ì„ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ í†µí•©
            overallReview += `## ğŸ“ ì½”ë“œ ë¦¬ë·°\n\n`;
            
            // ì „ì²´ ë³€ê²½ì‚¬í•­ì„ í•œë²ˆì— ìˆ˜ì§‘
            let allChanges = '';
            const filesSummary = [];
            
            for (const file of filesToReview) {
              filesSummary.push(`- ${file.filename} (+${file.additions}/-${file.deletions})`);
              allChanges += `\n### ${file.filename}\n`;
              allChanges += `\`\`\`diff\n${file.patch}\n\`\`\`\n`;
            }
            
            console.log('Sending single API request for all files...');
            
            try {
              const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'deepseek/deepseek-v3.1-base',  // DeepSeek V3.1 ëª¨ë¸ (ì•ˆì •ì ì¸ ì½”ë“œ ë¦¬ë·°)
                  messages: [{
                    role: 'system',
                    content: `ë‹¹ì‹ ì€ Kotlin Spring Boot ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                    Clean Architecture, DDD ì›ì¹™, Spring Boot ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì½”ë“œë¥¼ ë¦¬ë·°í•©ë‹ˆë‹¤.
                    
                    ê° íŒŒì¼ë³„ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
                    
                    #### ğŸ“„ [íŒŒì¼ëª…]
                    ğŸŸ¢ **Good**: ì˜ ì‘ì„±ëœ ë¶€ë¶„
                    ğŸŸ¡ **Suggest**: ê°œì„  ì œì•ˆ 
                    ğŸ”´ **Issue**: ë°˜ë“œì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ë¬¸ì œì 
                    ğŸ’¡ **Tip**: ì¶”ê°€ ê°œì„  ì•„ì´ë””ì–´
                    
                    íŠ¹íˆ ë‹¤ìŒì„ ì¤‘ì ì ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”:
                    - Entity: JPA ë§¤í•‘, ì—°ê´€ê´€ê³„, N+1 ë¬¸ì œ
                    - Service: íŠ¸ëœì­ì…˜, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ì˜ˆì™¸ ì²˜ë¦¬
                    - Controller: RESTful ì›ì¹™, HTTP ìƒíƒœ ì½”ë“œ, ê²€ì¦
                    - DTO: data class ì‚¬ìš©, nullable íƒ€ì…, ë¶ˆë³€ì„±
                    - Repository: ì¿¼ë¦¬ ìµœì í™”, ë„¤ì´ë° ê·œì¹™
                    - Test: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€, MockK ì‚¬ìš©, ê²©ë¦¬ì„±
                    - Config: ë³´ì•ˆ ì„¤ì •, í™˜ê²½ ë¶„ë¦¬
                    
                    ì½”ë“œ ì˜ˆì‹œëŠ” Kotlin ë¬¸ë²•ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.`
                  }, {
                    role: 'user',
                    content: `ë‹¤ìŒ PRì˜ ${filesToReview.length}ê°œ íŒŒì¼ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
                    
                    ë³€ê²½ëœ íŒŒì¼:
                    ${filesSummary.join('\n')}
                    
                    ì „ì²´ ë³€ê²½ì‚¬í•­:
                    ${allChanges}
                    
                    ê° íŒŒì¼ë³„ë¡œ êµ¬ì²´ì ì¸ ë¦¬ë·°ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.`
                  }],
                  max_tokens: 4000,  // ì „ì²´ ë¦¬ë·°ë¥¼ ìœ„í•´ í† í° ì¦ê°€
                  temperature: 0.3
                })
              });
              
              if (response.ok) {
                const result = await response.json();
                overallReview += result.choices[0].message.content + '\n\n';
                console.log('âœ… Single API review completed successfully!');
              } else {
                const errorText = await response.text();
                console.error('API request failed:', response.status, errorText);
                overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${response.status} - ${errorText}\n\n`;
              }
            } catch (error) {
              console.error('Error during review:', error);
              overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${error.message}\n\n`;
            }
            
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
            overallReview += `## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸\n\n`;
            overallReview += `- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ëŠ”ê°€?\n`;
            overallReview += `- [ ] Ktlint ê·œì¹™ì„ ì¤€ìˆ˜í•˜ëŠ”ê°€?\n`;
            overallReview += `- [ ] API ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ê°€?\n`;
            overallReview += `- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ê°€ í•„ìš”í•œê°€?\n`;
            overallReview += `- [ ] ë³´ì•ˆ ì·¨ì•½ì ì€ ì—†ëŠ”ê°€?\n\n`;
            
            overallReview += `---\n`;
            overallReview += `*ğŸ¤– AI Review powered by Qwen3 Coder via OpenRouter*\n`;
            overallReview += `*â±ï¸ Reviewed at: ${new Date().toISOString()}*`;
            
            // ìµœì¢… ë¦¬ë·° ì œì¶œ
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: overallReview,
              event: 'COMMENT'
            });
            
            console.log(`âœ… Review completed for ${filesToReview.length} files!`);